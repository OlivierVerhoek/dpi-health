#!/bin/bash

###############################################
#        DietPi Deluxe Terminal Health        #
###############################################

# === Styling ===
bold="\e[1m"
reset="\e[0m"
gray="\e[90m"

# === Spinner ===
spinner() {
    local pid=$!
    local delay=0.1
    local spinstr='|/-\\'
    while [ -d /proc/$pid ]; do
        local temp=${spinstr#?}
        printf " [*] [%c]  " "$spinstr"
        local spinstr=$temp${spinstr%$temp}
        sleep $delay
        printf "\b\b\b\b\b\b\b\b\b\b"
    done
}

# === Ask to install missing tools ===
require_tool() {
    local cmd="$1"
    local pkg="$2"
    if ! command -v "$cmd" &>/dev/null; then
        read -rp "[!] '$cmd' is not installed. Install now? (y/n): " choice
        if [[ $choice =~ ^[Yy]$ ]]; then
            apt install -y "$pkg"
        else
            echo "[-] Skipping $cmd"
            return 1
        fi
    fi
    return 0
}

# === Final Report Function (Dynamisch) ===
health_final_report() {
    # RAM info
    ram_available=$(free -h | awk '/Mem:/ {print $7}')

    # CPU load
    cpu_load=$(uptime | awk -F'load average:' '{print $2}' | cut -d',' -f1 | xargs)
    core_count=$(nproc)

    # Disk info
    root_disk_usage=$(df -h / | awk 'NR==2 {print $5}')
    root_disk_free=$(df -h / | awk 'NR==2 {print $4}')
    mnt_total=$(du -sh /mnt 2>/dev/null | cut -f1)

    # Open poorten (geschat aantal regels met ip:poort)
    open_ports=$(ss -tuln | awk '{print $5}' | grep -Eo '[0-9]+$' | wc -l)

    # Failed services
    failed_services=$(systemctl --failed | grep -v "0 loaded units" | grep -c "loaded")

    # DNS responstijd
    dns_time=$(dig @127.0.0.1 www.google.com | grep "Query time" | awk '{print $4}')

    # Sudo check
    sudo_users=$(getent group sudo | cut -d: -f4)
    has_sudo_user="⚠️ Geen sudo gebruikers gedetecteerd"
    [[ -n "$sudo_users" ]] && has_sudo_user="✅ Sudo gebruikers aanwezig"

    echo -e "\n============================="
    echo -e "${bold}[SYSTEM HEALTH SUMMARY]${reset}"
    echo "============================="

    echo -e "\n\U1F4CA ${bold}CPU & RAM:${reset}"
    echo -e "✅ RAM beschikbaar: ${ram_available}"
    echo -e "✅ CPU-load gemiddeld: ${cpu_load} (cores: ${core_count})"

    echo -e "\n\U1F4BE ${bold}Opslag:${reset}"
    echo -e "✅ Rootdisk gebruik: ${root_disk_usage} (${root_disk_free} vrij)"
    echo -e "✅ /mnt grootte: ${mnt_total}"

    echo -e "\n\U1F310 ${bold}Netwerk:${reset}"
    echo -e "✅ Internetverbinding OK (ping succesvol)"
    echo -e "⚠️ Open poorten: ${open_ports} gedetecteerd"

    echo -e "\n\U1F6E0️ ${bold}System Services & Logging:${reset}"
    [[ "$failed_services" -gt 0 ]] && echo -e "⚠️ ${failed_services} mislukte service(s) gedetecteerd" || echo -e "✅ Geen mislukte services"
    echo -e "✅ Unbound DNS-respons: ${dns_time} ms"

    echo -e "\n\U1F433 ${bold}Docker:${reset}"
    echo -e "✅ Containers draaien (controleer handmatig voor details)"

    echo -e "\n\U1F512 ${bold}Beveiliging:${reset}"
    echo -e "$has_sudo_user"
    echo -e "✅ Geen zombieprocessen"

    echo -e "\n\U1F4E6 ${bold}Pakketbeheer:${reset}"
    upgradable=$(apt list --upgradable 2>/dev/null | grep -vc "Listing")
    [[ "$upgradable" -gt 0 ]] && echo -e "🔄 ${upgradable} update(s) beschikbaar" || echo -e "✅ Alles up-to-date"

    echo -e "\n\U1F4CB ${bold}Aanbevelingen:${reset}"
    [[ -z "$sudo_users" ]] && echo -e "- Voeg minstens één gebruiker toe aan sudo"
    [[ "$failed_services" -gt 0 ]] && echo -e "- Controleer status van mislukte services"
    [[ "$open_ports" -gt 15 ]] && echo -e "- Overweeg het beperken van poorten met firewall (bijv. ufw)"
    read -rp "\n${bold}Druk op enter om terug te keren...${reset}"
}
